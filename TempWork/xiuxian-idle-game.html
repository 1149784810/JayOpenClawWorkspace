<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ä»™æŒ‚æœº - é—®é“é•¿ç”Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; color: #eee; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #e94560; margin-bottom: 20px; }
        .header h1 { font-size: 2.2em; color: #e94560; text-shadow: 0 0 20px rgba(233, 69, 96, 0.5); }
        .main-grid { display: grid; grid-template-columns: 280px 1fr 280px; gap: 15px; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
        .panel { background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 15px; border: 1px solid rgba(233, 69, 96, 0.3); }
        .panel-title { font-size: 1.1em; color: #e94560; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(233, 69, 96, 0.3); }
        .realm-name { font-size: 1.5em; color: #ffd700; text-align: center; margin-bottom: 5px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .progress-container { margin: 10px 0; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 0.85em; }
        .progress-bar { width: 100%; height: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.3s ease; background: linear-gradient(90deg, #e94560, #ff6b6b); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .stat-item { background: rgba(0, 0, 0, 0.2); padding: 8px; border-radius: 6px; text-align: center; }
        .stat-label { font-size: 0.75em; color: #888; }
        .stat-value { font-size: 1em; color: #fff; font-weight: bold; }
        .btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 0.95em; cursor: pointer; transition: all 0.3s ease; font-weight: bold; }
        .btn-primary { background: linear-gradient(135deg, #e94560, #c73e54); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, #ff5577, #e94560); transform: translateY(-2px); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .resources { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .resource-item { background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 8px; text-align: center; }
        .resource-icon { font-size: 1.5em; }
        .resource-name { color: #888; font-size: 0.8em; }
        .resource-value { color: #fff; font-size: 1.1em; font-weight: bold; }
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab { padding: 8px 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(233, 69, 96, 0.3); border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .tab.active { background: rgba(233, 69, 96, 0.3); border-color: #e94560; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .skill-list { display: flex; flex-direction: column; gap: 8px; }
        .skill-item { background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .item-card { background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; }
        .item-card:hover { border-color: rgba(233, 69, 96, 0.5); }
        .item-card.equipped { border-color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .log-container { max-height: 250px; overflow-y: auto; background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 10px; font-size: 0.85em; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .enemy-info { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .enemy-name { font-size: 1.3em; color: #ff6b6b; margin-bottom: 8px; }
        .combat-display { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center; }
        .combat-vs { font-size: 2em; color: #ffd700; margin: 10px 0; }
        .cd-bar { height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .cd-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00cc66); border-radius: 3px; transition: width 0.1s linear; }
        .dungeon-list { display: flex; flex-direction: column; gap: 10px; }
        .dungeon-item { background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .dungeon-item:hover { border-color: rgba(233, 69, 96, 0.5); }
        .dungeon-item.locked { opacity: 0.5; cursor: not-allowed; }
        .dungeon-item.selected { border-color: #ffd700; }
        .travel-map { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .map-location { background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .map-location:hover { border-color: rgba(233, 69, 96, 0.5); }
        .map-location.current { border-color: #00ff88; background: rgba(0, 255, 136, 0.1); }
        .equipment-slot { background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .rarity-common { color: #aaa; } .rarity-rare { color: #4169e1; } .rarity-epic { color: #9932cc; } .rarity-legendary { color: #ffd700; }
        .skill-cd { font-size: 0.75em; color: #888; margin-top: 3px; }
        .buff-list { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .buff-icon { background: rgba(233, 69, 96, 0.3); padding: 3px 8px; border-radius: 4px; font-size: 0.75em; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; border: 2px solid #e94560; }
        .modal-title { font-size: 1.5em; color: #e94560; margin-bottom: 20px; text-align: center; }
        .close-modal { float: right; font-size: 1.5em; cursor: pointer; color: #888; }
        .close-modal:hover { color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—¡ï¸ é—®é“é•¿ç”Ÿ</h1>
            <p style="color: #888; font-size: 0.9em;">æ”¾ç½®ä¿®ä»™ Â· é—®é“é•¿ç”Ÿ</p>
        </div>
        <div class="main-grid">
            <div class="panel">
                <div class="panel-title">è§’è‰²ä¿¡æ¯</div>
                <div class="realm-name" id="realmName">ç‚¼æ°”æœŸ</div>
                <div style="text-align: center; color: #aaa; margin-bottom: 15px; font-size: 0.9em;" id="realmStage">ä¸€é‡</div>
                <div class="progress-container">
                    <div class="progress-label"><span>ä¿®ä¸º</span><span id="cultivationText">0 / 100</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="cultivationBar" style="width: 0%"></div></div>
                </div>
                <div class="progress-container">
                    <div class="progress-label"><span>ç”Ÿå‘½å€¼</span><span id="playerHpText">100 / 100</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="playerHpBar" style="width: 100%; background: linear-gradient(90deg, #4169e1, #6495ed)"></div></div>
                </div>
                <div class="progress-container">
                    <div class="progress-label"><span>å¯¿å…ƒ</span><span id="lifespanText">100 / 100</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="lifespanBar" style="width: 100%; background: linear-gradient(90deg, #228b22, #32cd32)"></div></div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-label">æ”»å‡»åŠ›</div><div class="stat-value" id="atkValue">10</div></div>
                    <div class="stat-item"><div class="stat-label">é˜²å¾¡åŠ›</div><div class="stat-value" id="defValue">5</div></div>
                    <div class="stat-item"><div class="stat-label">æ”»å‡»é€Ÿåº¦</div><div class="stat-value" id="aspdValue">1.0</div></div>
                    <div class="stat-item"><div class="stat-label">ä¿®ç‚¼é€Ÿåº¦</div><div class="stat-value" id="speedValue">1/s</div></div>
                </div>
                <div class="buff-list" id="buffList"></div>
            </div>
            <div class="panel">
                <div class="resources">
                    <div class="resource-item"><div class="resource-icon">ğŸ’</div><div class="resource-name">çµçŸ³</div><div class="resource-value" id="spiritStones">0</div></div>
                    <div class="resource-item"><div class="resource-icon">ğŸŒ¿</div><div class="resource-name">çµè‰</div><div class="resource-value" id="herbs">0</div></div>
                    <div class="resource-item"><div class="resource-icon">âš—ï¸</div><div class="resource-name">ä¸¹è¯</div><div class="resource-value" id="pills">0</div></div>
                    <div class="resource-item"><div class="resource-icon">ğŸ“œ</div><div class="resource-name">åŠŸæ³•ç‚¹</div><div class="resource-value" id="skillPoints">0</div></div>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('cultivation')">ä¿®ç‚¼</div>
                    <div class="tab" onclick="switchTab('combat')">æˆ˜æ–—</div>
                    <div class="tab" onclick="switchTab('dungeon')">å‰¯æœ¬</div>
                    <div class="tab" onclick="switchTab('travel')">æ¸¸å†</div>
                    <div class="tab" onclick="switchTab('bag')">èƒŒåŒ…</div>
                    <div class="tab" onclick="switchTab('forge')">é”»é€ </div>
                    <div class="tab" onclick="switchTab('skills')">åŠŸæ³•</div>
                    <div class="tab" onclick="switchTab('alchemy')">ç‚¼ä¸¹</div>
                </div>
                <div class="tab-content active" id="cultivation">
                    <button class="btn btn-primary" onclick="meditate()">ğŸ§˜ æ‰“åä¿®ç‚¼ (+25ä¿®ä¸º)</button>
                    <button class="btn btn-secondary" onclick="breakthrough()">âš¡ å°è¯•çªç ´</button>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <p style="color: #888; text-align: center; font-size: 0.9em;">è‡ªåŠ¨ä¿®ç‚¼: <span id="autoCultivation">1</span> ä¿®ä¸º/ç§’<br>ç¦»çº¿æ”¶ç›Šæœ€å¤šç´¯è®¡12å°æ—¶</p>
                        <p style="color: #ffd700; text-align: center; font-size: 0.85em; margin-top: 10px;" id="offlineReward"></p>
                    </div>
                </div>
                <div class="tab-content" id="combat">
                    <div class="combat-display" id="combatDisplay" style="display: none;">
                        <div style="display: flex; justify-content: space-around; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.2em; color: #4169e1;">ä½ </div>
                                <div style="font-size: 0.85em; color: #888;">HP: <span id="combatPlayerHp">100</span></div>
                                <div class="cd-bar" style="width: 100px; margin: 5px auto;"><div class="cd-fill" id="playerCdBar" style="width: 0%"></div></div>
                            </div>
                            <div class="combat-vs">âš”ï¸</div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2em; color: #ff6b6b;">æ•Œäºº</div>
                                <div style="font-size: 0.85em; color: #888;">HP: <span id="combatEnemyHp">50</span></div>
                                <div class="cd-bar" style="width: 100px; margin: 5px auto;"><div class="cd-fill" id="enemyCdBar" style="width: 0%; background: linear-gradient(90deg, #ff4444, #ff6666)"></div></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;" id="combatSkills"></div>
                    </div>
                    <div class="enemy-info" id="enemyInfo">
                        <div class="enemy-name" id="enemyName">é‡ç‹¼</div>
                        <div class="progress-container"><div class="progress-bar"><div class="progress-fill" id="enemyHpBar" style="width: 100%; background: linear-gradient(90deg, #ff4444, #ff6666)"></div></div></div>
                        <p style="color: #888; font-size: 0.9em;">æˆ˜åŠ›: <span id="enemyPower">15</span> | æ”»å‡»: <span id="enemyAtk">8</span> | æ‰è½: <span id="enemyDrop">çµè‰ x1-3</span></p>
                    </div>
                    <button class="btn btn-primary" id="combatBtn" onclick="toggleCombat()">âš”ï¸ å¼€å§‹æˆ˜æ–—</button>
                    <button class="btn btn-secondary" onclick="nextEnemy()">ğŸ” æ›´æ¢å¯¹æ‰‹</button>
                </div>
                <div class="tab-content" id="dungeon"><div class="dungeon-list" id="dungeonList"></div></div>
                <div class="tab-content" id="travel">
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <p style="color: #888; font-size: 0.9em;">å½“å‰ä½ç½®: <span id="currentLocation" style="color: #ffd700;">é’äº‘å®—</span></p>
                        <p style="color: #888; font-size: 0.85em; margin-top: 5px;">æ¸¸å†å¯è·å¾—éšæœºèµ„æºã€è£…å¤‡å’Œå¥‡é‡</p>
                    </div>
                    <div class="travel-map" id="travelMap"></div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="startTravel()">ğŸ² å¼€å§‹æ¸¸å† (æ¶ˆè€—10çµçŸ³)</button>
                    <div class="log-container" style="margin-top: 15px; max-height: 150px;" id="travelLog"></div>
                </div>
                <div class="tab-content" id="bag">
                    <div class="tabs" style="margin-bottom: 10px;">
                        <div class="tab active" onclick="switchBagTab('equipment')" id="bagTab-equipment">è£…å¤‡</div>
                        <div class="tab" onclick="switchBagTab('pills')" id="bagTab-pills">ä¸¹è¯</div>
                    </div>
                    <div id="bagContent-equipment">
                        <div style="margin-bottom: 15px;">
                            <div class="panel-title" style="font-size: 1em;">å·²è£…å¤‡</div>
                            <div id="equippedItems">
                                <div class="equipment-slot"><span>ğŸ—¡ï¸ æ­¦å™¨</span><span style="color: #888;" id="equipWeapon">æ— </span></div>
                                <div class="equipment-slot"><span>ğŸ›¡ï¸ é˜²å…·</span><span style="color: #888;" id="equipArmor">æ— </span></div>
                                <div class="equipment-slot"><span>ğŸ’ é¥°å“</span><span style="color: #888;" id="equipAccessory">æ— </span></div>
                            </div>
                        </div>
                        <div>
                            <div class="panel-title" style="font-size: 1em; display: flex; justify-content: space-between; align-items: center;">
                                <span>è£…å¤‡èƒŒåŒ… (<span id="bagCount">0</span>/50)</span>
                                <button class="btn btn-secondary" style="width: auto; padding: 5px 15px; font-size: 0.8em; margin: 0;" onclick="sellAllItems()">ğŸ’° ä¸€é”®å‡ºå”®</button>
                            </div>
                            <div class="item-grid" id="bagItems"></div>
                        </div>
                    </div>
                    <div id="bagContent-pills" style="display: none;">
                        <div class="panel-title" style="font-size: 1em;">ä¸¹è¯èƒŒåŒ… (<span id="pillsCount">0</span>/50)</div>
                        <p style="color: #888; font-size: 0.85em; margin-bottom: 10px;">ç‚¹å‡»ä¸¹è¯ä½¿ç”¨ï¼ˆæˆ˜æ–—ä¸­ä¹Ÿå¯ä½¿ç”¨ï¼‰</p>
                        <div class="item-grid" id="pillItems"></div>
                    </div>
                </div>
                <div class="tab-content" id="forge">
                    <div class="panel-title" style="font-size: 1em;">é”»é€ è£…å¤‡</div>
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="color: #888; font-size: 0.9em; margin-bottom: 10px;">æ¶ˆè€—ææ–™é”»é€ è£…å¤‡ï¼Œå“è´¨éšæœº</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div class="item-card" onclick="forgeItem('weapon')">
                                <div style="font-size: 2em;">ğŸ—¡ï¸</div>
                                <div style="font-weight: bold;">é”»é€ æ­¦å™¨</div>
                                <div style="color: #888; font-size: 0.8em;">çµçŸ³ x20<br>çµè‰ x10</div>
                            </div>
                            <div class="item-card" onclick="forgeItem('armor')">
                                <div style="font-size: 2em;">ğŸ›¡ï¸</div>
                                <div style="font-weight: bold;">é”»é€ é˜²å…·</div>
                                <div style="color: #888; font-size: 0.8em;">çµçŸ³ x20<br>çµè‰ x10</div>
                            </div>
                            <div class="item-card" onclick="forgeItem('accessory')">
                                <div style="font-size: 2em;">ğŸ’</div>
                                <div style="font-weight: bold;">é”»é€ é¥°å“</div>
                                <div style="color: #888; font-size: 0.8em;">çµçŸ³ x30<br>çµè‰ x15</div>
                            </div>
                        </div>
                    </div>
                    <div id="forgeResult" style="text-align: center; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px; display: none;"></div>
                </div>
                <div class="tab-content" id="skills"><div class="skill-list" id="skillList"></div></div>
                <div class="tab-content" id="alchemy"><div class="item-grid" id="alchemyGrid"></div></div>
            </div>
            <div class="panel">
                <div class="panel-title">ä¿®ä»™æ—¥å¿—</div>
                <div class="log-container" id="logContainer"><div class="log-entry" style="color: #ffd700;">æ¬¢è¿æ¥åˆ°ä¿®ä»™ä¸–ç•Œï¼</div></div>
                <button class="btn btn-secondary" style="margin-top: 10px; padding: 8px; font-size: 0.85em;" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn btn-secondary" style="padding: 8px; font-size: 0.85em;" onclick="exportSave()">å¯¼å‡ºå­˜æ¡£</button>
                <button class="btn btn-secondary" style="padding: 8px; font-size: 0.85em;" onclick="importSave()">å¯¼å…¥å­˜æ¡£</button>
                <button class="btn btn-secondary" style="padding: 8px; font-size: 0.85em;" onclick="resetGame()">é‡ç½®æ¸¸æˆ</button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-title" id="modalTitle">æ ‡é¢˜</div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ® - é»˜è®¤ç»“æ„
        const defaultGameData = {
            player: {
                realm: 0, stage: 1, cultivation: 0,
                hp: 100, maxHp: 100, lifespan: 100, maxLifespan: 100,
                baseAtk: 10, baseDef: 5, baseAspd: 1,
                spiritStones: 0, herbs: 0, pills: 0, skillPoints: 0
            },
            combat: { inCombat: false, enemy: null, playerCd: 0, enemyCd: 0 },
            equipment: { weapon: null, armor: null, accessory: null },
            bag: [],
            pillsBag: [],
            buffs: [],
            skills: [],
            currentEnemyIdx: 0,
            currentLocation: 0,
            lastOnline: Date.now()
        };
        
        // åˆ›å»º gameData å¹¶åˆå¹¶é»˜è®¤å€¼
        const gameData = JSON.parse(JSON.stringify(defaultGameData));

        const realms = ['ç‚¼æ°”æœŸ', 'ç­‘åŸºæœŸ', 'é‡‘ä¸¹æœŸ', 'å…ƒå©´æœŸ', 'åŒ–ç¥æœŸ', 'ç‚¼è™šæœŸ', 'åˆä½“æœŸ', 'å¤§ä¹˜æœŸ', 'æ¸¡åŠ«æœŸ', 'çœŸä»™'];
        const enemies = [
            { name: 'é‡ç‹¼', hp: 50, atk: 8, aspd: 1.2, exp: 10, drops: { herbs: [1,3], pillChance: 0.3 } },
            { name: 'å±±è´¼', hp: 80, atk: 12, aspd: 1, exp: 15, drops: { spiritStones: [5,10], pillChance: 0.4 } },
            { name: 'å¦–è™', hp: 150, atk: 20, aspd: 1.5, exp: 30, drops: { herbs: [3,5], pills: [1,2], pillChance: 0.6 } },
            { name: 'é­”ä¿®', hp: 200, atk: 25, aspd: 1.3, exp: 50, drops: { spiritStones: [10,20], skillPoints: [1,3], pillChance: 0.7 } }
        ];
        const dungeons = [
            { name: 'æ–°æ‰‹è¯•ç‚¼', power: 10, reward: { spiritStones: 20, herbs: 5 } },
            { name: 'å¦–å…½æ£®æ—', power: 30, reward: { spiritStones: 50, herbs: 15, pills: 2 } },
            { name: 'é­”å®—é—è¿¹', power: 60, reward: { spiritStones: 100, skillPoints: 5 } },
            { name: 'ä¸Šå¤æˆ˜åœº', power: 100, reward: { spiritStones: 200, pills: 5, skillPoints: 10 } }
        ];
        const locations = ['é’äº‘å®—', 'è½éœè°·', 'ä¸‡å‰‘å±±', 'ç‚¼ä¸¹é˜', 'çµçŸ¿è„‰', 'å¦–å…½æ—'];
        const skillData = [
            { id: 1, name: 'åŸºç¡€åçº³', desc: 'æå‡ä¿®ç‚¼é€Ÿåº¦', effect: 'speed', value: 0.2, cost: 10 },
            { id: 2, name: 'é‡‘èº«è¯€', desc: 'æå‡é˜²å¾¡åŠ›', effect: 'def', value: 2, cost: 10 },
            { id: 3, name: 'å¾¡å‰‘æœ¯', desc: 'æå‡æ”»å‡»åŠ›', effect: 'atk', value: 3, cost: 10 },
            { id: 4, name: 'ç–¾é£æ­¥', desc: 'æå‡æ”»å‡»é€Ÿåº¦', effect: 'aspd', value: 0.1, cost: 15 },
            { id: 5, name: 'ç«çƒæœ¯', desc: 'æˆ˜æ–—æŠ€èƒ½:é€ æˆ150%ä¼¤å®³', effect: 'skill', value: 1.5, cd: 5, cost: 20 },
            { id: 6, name: ' healing', desc: 'æˆ˜æ–—æŠ€èƒ½:å›å¤30%ç”Ÿå‘½', effect: 'heal', value: 0.3, cd: 8, cost: 20 }
        ];
        const recipes = [
            { id: 'spirit', name: 'èšæ°”ä¸¹', icon: 'ğŸ’Š', cost: { herbs: 5 }, effect: 'ä¿®ç‚¼é€Ÿåº¦+50%æŒç»­5åˆ†é’Ÿ' },
            { id: 'breakthrough', name: 'ç ´å¢ƒä¸¹', icon: 'ğŸŒŸ', cost: { herbs: 20, spiritStones: 50 }, effect: 'çªç ´æˆåŠŸç‡+30%' },
            { id: 'lifespan', name: 'å¯¿å…ƒä¸¹', icon: 'ğŸ‘', cost: { herbs: 50, spiritStones: 100 }, effect: 'å¯¿å…ƒ+10å¹´' }
        ];

        // æˆ˜æ–—ä¸¹è¯å®šä¹‰
        const pillTypes = [
            { id: 'healSmall', name: 'å›æ˜¥ä¸¹', icon: 'ğŸ’š', effect: 'heal', value: 30, desc: 'å›å¤30%ç”Ÿå‘½å€¼' },
            { id: 'healMedium', name: 'ç”Ÿè‚Œä¸¹', icon: 'ğŸ’™', effect: 'heal', value: 50, desc: 'å›å¤50%ç”Ÿå‘½å€¼' },
            { id: 'healLarge', name: 'ä¹è½¬è¿˜é­‚ä¸¹', icon: 'ğŸ’œ', effect: 'heal', value: 80, desc: 'å›å¤80%ç”Ÿå‘½å€¼' },
            { id: 'cultivationSmall', name: 'èšæ°”ä¸¹', icon: 'ğŸ’›', effect: 'cultivation', value: 50, desc: 'å¢åŠ 50ç‚¹ä¿®ä¸º' },
            { id: 'cultivationMedium', name: 'å¢å…ƒä¸¹', icon: 'ğŸ§¡', effect: 'cultivation', value: 150, desc: 'å¢åŠ 150ç‚¹ä¿®ä¸º' },
            { id: 'cultivationLarge', name: 'å¤©çµä¸¹', icon: 'â¤ï¸', effect: 'cultivation', value: 500, desc: 'å¢åŠ 500ç‚¹ä¿®ä¸º' }
        ];

        // åˆå§‹åŒ–
        function init() {
            // å…ˆä¿å­˜å½“å‰ skills å¼•ç”¨ï¼ˆå¦‚æœ loadGame åæœ‰æ•°æ®ï¼‰
            loadGame();
            calculateOfflineReward();
            
            // ç¡®ä¿ skills æ•°æ®æ­£ç¡®åˆå¹¶
            if (!gameData.skills || gameData.skills.length === 0) {
                gameData.skills = skillData.map(s => ({ ...s, level: 0, cd: 0 }));
            } else {
                // ä¿ç•™å­˜æ¡£ä¸­çš„æŠ€èƒ½ç­‰çº§ï¼Œä½†æ›´æ–°æ¨¡æ¿æ•°æ®
                const savedSkills = JSON.parse(JSON.stringify(gameData.skills));
                gameData.skills = skillData.map(template => {
                    const saved = savedSkills.find(s => s.id === template.id);
                    return { ...template, level: saved ? saved.level : 0, cd: 0 };
                });
            }
            renderSkills();
            
            // åˆå§‹åŒ–è£…å¤‡å’Œä¸¹è¯
            initEquipment();
            initAlchemy();
            initDungeons();
            initTravel();
            updateUI();
            setInterval(gameLoop, 100);
            setInterval(saveGame, 10000);
        }

        function initSkills() {
            // å¦‚æœæ²¡æœ‰å­˜æ¡£çš„æŠ€èƒ½æ•°æ®ï¼Œæ‰åˆå§‹åŒ–
            if (!gameData.skills || gameData.skills.length === 0) {
                gameData.skills = skillData.map(s => ({ ...s, level: 0, cd: 0 }));
            } else {
                // åˆå¹¶å­˜æ¡£æ•°æ®å’ŒæŠ€èƒ½æ¨¡æ¿ï¼ˆç¡®ä¿æ–°æŠ€èƒ½ä¹Ÿèƒ½è¢«åŠ è½½ï¼‰
                gameData.skills = skillData.map(template => {
                    const saved = gameData.skills.find(s => s.id === template.id);
                    return saved ? { ...template, ...saved, cd: 0 } : { ...template, level: 0, cd: 0 };
                });
            }
            renderSkills();
        }

        function initEquipment() {
            // ç¡®ä¿è£…å¤‡æ•°æ®å­˜åœ¨
            if (!gameData.equipment) {
                gameData.equipment = { weapon: null, armor: null, accessory: null };
            }
            if (!gameData.bag) {
                gameData.bag = [];
            }
            if (!gameData.pillsBag) {
                gameData.pillsBag = [];
            }
            if (!gameData.buffs) {
                gameData.buffs = [];
            }
            renderBag();
            renderEquipped();
            renderPills();
            updateBuffDisplay();
        }

        function initAlchemy() {
            const grid = document.getElementById('alchemyGrid');
            grid.innerHTML = recipes.map(r => `
                <div class="item-card" onclick="craftPill('${r.id}')">
                    <div style="font-size: 2em;">${r.icon}</div>
                    <div style="font-weight: bold;">${r.name}</div>
                    <div style="color: #888; font-size: 0.8em;">${Object.entries(r.cost).map(([k,v])=>`${k==='herbs'?'ğŸŒ¿':'ğŸ’'}${v}`).join(' ')}</div>
                    <div style="color: #e94560; font-size: 0.75em;">${r.effect}</div>
                </div>
            `).join('');
        }

        function initDungeons() {
            const list = document.getElementById('dungeonList');
            const playerPower = getPlayerPower();
            list.innerHTML = dungeons.map((d,i) => `
                <div class="dungeon-item ${playerPower < d.power ? 'locked' : ''}" onclick="enterDungeon(${i})">
                    <div style="font-weight: bold;">${d.name}</div>
                    <div style="color: #888; font-size: 0.85em;">æ¨èæˆ˜åŠ›: ${d.power} | ä½ çš„æˆ˜åŠ›: ${playerPower}</div>
                    <div style="color: #ffd700; font-size: 0.8em;">å¥–åŠ±: ${Object.entries(d.reward).map(([k,v])=>v+['çµçŸ³','çµè‰','ä¸¹è¯','åŠŸæ³•ç‚¹'][['spiritStones','herbs','pills','skillPoints'].indexOf(k)]).join(', ')}</div>
                </div>
            `).join('');
        }

        function initTravel() {
            const map = document.getElementById('travelMap');
            map.innerHTML = locations.map((l,i) => `
                <div class="map-location ${i===gameData.currentLocation?'current':''}" onclick="setLocation(${i})">
                    <div style="font-size: 1.5em;">${['ğŸ”ï¸','ğŸŒ„','âš”ï¸','âš—ï¸','â›ï¸','ğŸº'][i]}</div>
                    <div style="font-size: 0.85em;">${l}</div>
                </div>
            `).join('');
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            // è‡ªåŠ¨ä¿®ç‚¼ (æ¯0.1ç§’æ‰§è¡Œä¸€æ¬¡)
            const baseSpeed = 5 + gameData.player.realm * 2;
            const skillBonus = getSkillBonus('speed');
            const buffBonus = getBuffBonus('speed');
            gameData.player.cultivation += (baseSpeed + skillBonus + buffBonus) * 0.1;
            
            // å¯¿å‘½æ¶ˆè€—
            if (Math.random() < 0.0001) gameData.player.lifespan -= 0.1;
            
            // æˆ˜æ–—é€»è¾‘
            if (gameData.combat.inCombat && gameData.combat.enemy) {
                updateCombat();
            }
            
            // æŠ€èƒ½CD
            gameData.skills.forEach(s => { if (s.cd > 0) s.cd -= 0.1; });
            
            // Buffå€’è®¡æ—¶æ›´æ–°ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡æ˜¾ç¤ºï¼‰
            if (Math.floor(Date.now() / 1000) % 1 === 0) {
                updateBuffDisplay();
            }
            
            updateUI();
        }

        // æˆ˜æ–—ç³»ç»Ÿ
        function updateCombat() {
            const c = gameData.combat;
            const p = gameData.player;
            const e = c.enemy;
            
            // CDè¿›åº¦
            c.playerCd += p.baseAspd + getSkillBonus('aspd');
            c.enemyCd += e.aspd;
            
            // ç©å®¶æ”»å‡»
            if (c.playerCd >= 2) {
                c.playerCd = 0;
                const dmg = Math.max(1, (p.baseAtk + getSkillBonus('atk') + getEquipBonus('atk')) - e.def || 0);
                e.hp -= dmg;
                addLog(`ä½ å¯¹${e.name}é€ æˆ${dmg}ç‚¹ä¼¤å®³`, '#888');
                
                // è‡ªåŠ¨é‡Šæ”¾æŠ€èƒ½
                const skill = gameData.skills.find(s => s.effect === 'skill' && s.level > 0 && s.cd <= 0);
                if (skill) useSkill(skill);
            }
            
            // æ•Œäººæ”»å‡»
            if (c.enemyCd >= 2) {
                c.enemyCd = 0;
                const def = p.baseDef + getSkillBonus('def') + getEquipBonus('def');
                const dmg = Math.max(1, e.atk - def);
                p.hp -= dmg;
                addLog(`${e.name}å¯¹ä½ é€ æˆ${dmg}ç‚¹ä¼¤å®³`, '#ff6b6b');
            }
            
            // æˆ˜æ–—ç»“æŸ
            if (e.hp <= 0) winCombat();
            else if (p.hp <= 0) loseCombat();
            
            updateCombatUI();
        }

        function useSkill(skill) {
            const e = gameData.combat.enemy;
            const p = gameData.player;
            skill.cd = skillData.find(s=>s.id===skill.id).cd;
            
            if (skill.effect === 'skill') {
                const dmg = Math.floor((p.baseAtk + getSkillBonus('atk')) * skill.value);
                e.hp -= dmg;
                addLog(`ğŸ”¥ ç«çƒæœ¯é€ æˆ${dmg}ç‚¹ä¼¤å®³!`, '#ff6b6b');
            } else if (skill.effect === 'heal') {
                const heal = Math.floor(p.maxHp * skill.value);
                p.hp = Math.min(p.maxHp, p.hp + heal);
                addLog(`ğŸ’š å›å¤${heal}ç‚¹ç”Ÿå‘½`, '#00ff88');
            }
            updateCombatUI();
        }

        function winCombat() {
            const e = enemies[gameData.currentEnemyIdx];
            addLog(`ğŸ‰ å‡»è´¥${e.name}!`, '#ffd700');
            
            // æ‰è½
            if (e.drops.herbs) gameData.player.herbs += rand(...e.drops.herbs);
            if (e.drops.spiritStones) gameData.player.spiritStones += rand(...e.drops.spiritStones);
            if (e.drops.pills) gameData.player.pills += rand(...e.drops.pills);
            if (e.drops.skillPoints) gameData.player.skillPoints += rand(...e.drops.skillPoints);
            
            // ç»éªŒ
            gameData.player.cultivation += e.exp;
            
            // è£…å¤‡æ‰è½
            if (Math.random() < 0.3) dropEquipment();
            
            // ä¸¹è¯æ‰è½
            if (e.drops.pillChance && Math.random() < e.drops.pillChance && gameData.pillsBag.length < 50) {
                dropPill();
            }
            
            endCombat();
        }

        function dropPill() {
            // æ£€æŸ¥ä¸¹è¯èƒŒåŒ…ä¸Šé™
            if (gameData.pillsBag.length >= 50) {
                addLog('âŒ ä¸¹è¯èƒŒåŒ…å·²æ»¡', '#ff4444');
                return;
            }
            
            // æ ¹æ®æ•Œäººå¼ºåº¦å†³å®šä¸¹è¯å“è´¨
            const enemyPower = gameData.currentEnemyIdx;
            let availablePills;
            if (enemyPower <= 1) availablePills = ['healSmall', 'cultivationSmall'];
            else if (enemyPower <= 2) availablePills = ['healSmall', 'healMedium', 'cultivationSmall', 'cultivationMedium'];
            else availablePills = ['healMedium', 'healLarge', 'cultivationMedium', 'cultivationLarge'];
            
            const pillType = availablePills[rand(0, availablePills.length - 1)];
            const pillTemplate = pillTypes.find(p => p.id === pillType);
            
            const pill = {
                id: Date.now() + rand(0, 1000),
                ...pillTemplate
            };
            
            gameData.pillsBag.push(pill);
            renderPills();
            addLog(`ğŸ’Š è·å¾—${pill.name}!`, '#00ff88');
        }

        function loseCombat() {
            addLog('ğŸ’€ ä½ è¢«æ‰“è´¥äº†...', '#ff4444');
            gameData.player.hp = 1;
            endCombat();
        }

        function endCombat() {
            gameData.combat.inCombat = false;
            gameData.combat.enemy = null;
            document.getElementById('combatDisplay').style.display = 'none';
            document.getElementById('enemyInfo').style.display = 'block';
            document.getElementById('combatBtn').textContent = 'âš”ï¸ å¼€å§‹æˆ˜æ–—';
        }

        function dropEquipment() {
            const rarities = ['common','common','rare','epic','legendary'];
            const rarity = rarities[Math.floor(Math.random() * rarities.length)];
            const types = ['weapon','armor','accessory'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            const item = {
                id: Date.now(),
                name: generateItemName(type, rarity),
                type, rarity,
                atk: type==='weapon'?rand(5,15)*(rarity==='legendary'?3:rarity==='epic'?2:rarity==='rare'?1.5:1):0,
                def: type==='armor'?rand(3,10)*(rarity==='legendary'?3:rarity==='epic'?2:rarity==='rare'?1.5:1):0,
                hp: type==='accessory'?rand(20,50)*(rarity==='legendary'?3:rarity==='epic'?2:rarity==='rare'?1.5:1):0
            };
            
            if (gameData.bag.length < 50) {
                gameData.bag.push(item);
                addLog(`ğŸ è·å¾—${getRarityName(rarity)}${item.name}!`, getRarityColor(rarity));
                renderBag();
            } else {
                addLog('âŒ èƒŒåŒ…å·²æ»¡ï¼Œæ— æ³•è·å¾—è£…å¤‡', '#ff4444');
            }
        }

        function generateItemName(type, rarity) {
            const prefixes = { common: ['ç ´æ—§çš„','æ™®é€šçš„'], rare: ['ç²¾è‰¯çš„','ç¨€æœ‰çš„'], epic: ['å²è¯—çš„','ä¼ è¯´çš„'], legendary: ['ç¥è¯çš„','è‡³å°Šçš„'] };
            const names = { weapon: ['é“å‰‘','é•¿åˆ€','æ³•æ–','é£å‰‘'], armor: ['å¸ƒç”²','çš®ç”²','é“ç”²','ä»™è¢'], accessory: ['ç‰ä½©','æˆ’æŒ‡','é¡¹é“¾','æ‰‹é•¯'] };
            return prefixes[rarity][rand(0,1)] + names[type][rand(0,3)];
        }

        // UIæ›´æ–°
        function updateUI() {
            const p = gameData.player;
            const reqCult = getReqCultivation();
            document.getElementById('realmName').textContent = realms[p.realm];
            document.getElementById('realmStage').textContent = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å'][p.stage-1] + 'é‡';
            document.getElementById('cultivationText').textContent = `${Math.floor(p.cultivation)} / ${reqCult}`;
            document.getElementById('cultivationBar').style.width = `${Math.min(100, p.cultivation/reqCult*100)}%`;
            document.getElementById('playerHpText').textContent = `${Math.floor(p.hp)} / ${p.maxHp}`;
            document.getElementById('playerHpBar').style.width = `${p.hp/p.maxHp*100}%`;
            document.getElementById('lifespanText').textContent = `${Math.floor(p.lifespan)} / ${p.maxLifespan}`;
            document.getElementById('lifespanBar').style.width = `${p.lifespan/p.maxLifespan*100}%`;
            document.getElementById('atkValue').textContent = p.baseAtk + getSkillBonus('atk') + getEquipBonus('atk');
            document.getElementById('defValue').textContent = p.baseDef + getSkillBonus('def') + getEquipBonus('def');
            document.getElementById('aspdValue').textContent = (p.baseAspd + getSkillBonus('aspd')).toFixed(1);
            document.getElementById('speedValue').textContent = (5 + p.realm * 2 + getSkillBonus('speed') + getBuffBonus('speed')).toFixed(1) + '/s';
            document.getElementById('spiritStones').textContent = p.spiritStones;
            document.getElementById('herbs').textContent = p.herbs;
            document.getElementById('pills').textContent = p.pills;
            document.getElementById('skillPoints').textContent = p.skillPoints;
            document.getElementById('autoCultivation').textContent = (5 + p.realm * 2 + getSkillBonus('speed') + getBuffBonus('speed')).toFixed(1);
            
            renderEquipped();
        }

        function renderPills() {
            const grid = document.getElementById('pillItems');
            const countEl = document.getElementById('pillsCount');
            if (countEl) countEl.textContent = gameData.pillsBag.length;
            if (!grid) return;
            
            grid.innerHTML = gameData.pillsBag.map(pill => {
                // ä½¿ç”¨ JSON.stringify ç¡®ä¿å­—ç¬¦ä¸² id è¢«æ­£ç¡®è½¬ä¹‰
                const pillId = JSON.stringify(pill.id);
                return `<div class="item-card" onclick='usePill(${pillId})'>
                    <div style="font-size: 2em;">${pill.icon}</div>
                    <div style="font-weight: bold; font-size: 0.9em;">${pill.name}</div>
                    <div style="color: #888; font-size: 0.75em;">${pill.desc}</div>
                </div>`;
            }).join('') || '<div style="color: #888; text-align: center; grid-column: 1/-1;">æš‚æ— ä¸¹è¯</div>';
        }

        function usePill(id) {
            const pillIndex = gameData.pillsBag.findIndex(p => p.id === id);
            if (pillIndex === -1) {
                console.log('ä¸¹è¯æœªæ‰¾åˆ°:', id, 'å½“å‰èƒŒåŒ…:', gameData.pillsBag.map(p => p.id));
                return;
            }
            
            const pill = gameData.pillsBag[pillIndex];
            
            if (pill.effect === 'heal') {
                const healAmount = Math.floor(gameData.player.maxHp * (pill.value / 100));
                gameData.player.hp = Math.min(gameData.player.maxHp, gameData.player.hp + healAmount);
                addLog(`ğŸ’š ä½¿ç”¨${pill.name}ï¼Œå›å¤${healAmount}ç‚¹ç”Ÿå‘½`, '#00ff88');
            } else if (pill.effect === 'cultivation') {
                gameData.player.cultivation += pill.value;
                addLog(`ğŸ’› ä½¿ç”¨${pill.name}ï¼Œä¿®ä¸º+${pill.value}`, '#ffd700');
            }
            
            // ç§»é™¤ä½¿ç”¨çš„ä¸¹è¯
            gameData.pillsBag.splice(pillIndex, 1);
            renderPills();
            updateUI();
            saveGame();
        }

        function updateCombatUI() {
            const c = gameData.combat;
            document.getElementById('combatPlayerHp').textContent = Math.floor(gameData.player.hp);
            document.getElementById('combatEnemyHp').textContent = Math.floor(c.enemy.hp);
            document.getElementById('playerCdBar').style.width = `${Math.min(100, c.playerCd/2*100)}%`;
            document.getElementById('enemyCdBar').style.width = `${Math.min(100, c.enemyCd/2*100)}%`;
        }

        function renderSkills() {
            const list = document.getElementById('skillList');
            list.innerHTML = gameData.skills.map(s => `
                <div class="skill-item">
                    <div>
                        <div style="font-weight: bold;">${s.name}</div>
                        <div style="color: #888; font-size: 0.85em;">${s.desc}</div>
                        ${s.level>0 && s.cd>0 ? `<div class="skill-cd">CD: ${s.cd.toFixed(1)}s</div>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #ffd700; font-weight: bold;">Lv.${s.level}</div>
                        <button class="btn btn-secondary" style="padding: 5px 10px; margin-top: 5px; font-size: 0.8em;" onclick="upgradeSkill(${s.id})" ${gameData.player.skillPoints < s.cost * s.level ? 'disabled' : ''}>
                            å‡çº§ (${s.cost * (s.level || 1)}ç‚¹)
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderBag() {
            document.getElementById('bagCount').textContent = gameData.bag.length;
            const grid = document.getElementById('bagItems');
            const rarityValues = { common: 5, rare: 15, epic: 40, legendary: 100 };
            grid.innerHTML = gameData.bag.map(item => `
                <div class="item-card ${isEquipped(item)?'equipped':''}">
                    <div onclick="clickItem(${item.id})" style="cursor: pointer;">
                        <div style="font-size: 1.5em;">${item.type==='weapon'?'ğŸ—¡ï¸':item.type==='armor'?'ğŸ›¡ï¸':'ğŸ’'}</div>
                        <div style="font-weight: bold; ${getRarityColor(item.rarity)}; font-size: 0.9em;">${item.name}</div>
                        <div style="color: #888; font-size: 0.75em;">${item.atk?`æ”»å‡»+${item.atk}`:item.def?`é˜²å¾¡+${item.def}`:`ç”Ÿå‘½+${item.hp}`}</div>
                    </div>
                    <button class="btn btn-secondary" style="padding: 3px 8px; font-size: 0.7em; margin: 5px 0 0 0; ${isEquipped(item)?'display:none;':''}" onclick="sellItem(${item.id}, event)">
                        å‡ºå”® ${rarityValues[item.rarity]}ğŸ’
                    </button>
                </div>
            `).join('') || '<div style="color: #888; text-align: center; grid-column: 1/-1;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>';
        }

        function renderEquipped() {
            const eq = gameData.equipment;
            document.getElementById('equipWeapon').innerHTML = eq.weapon ? `<span class="${getRarityColor(eq.weapon.rarity)}">${eq.weapon.name}</span>` : 'æ— ';
            document.getElementById('equipArmor').innerHTML = eq.armor ? `<span class="${getRarityColor(eq.armor.rarity)}">${eq.armor.name}</span>` : 'æ— ';
            document.getElementById('equipAccessory').innerHTML = eq.accessory ? `<span class="${getRarityColor(eq.accessory.rarity)}">${eq.accessory.name}</span>` : 'æ— ';
        }

        // æ“ä½œå‡½æ•°
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function toggleCombat() {
            if (gameData.combat.inCombat) {
                endCombat();
            } else {
                startCombat();
            }
        }

        function startCombat() {
            const e = enemies[gameData.currentEnemyIdx];
            gameData.combat.inCombat = true;
            gameData.combat.enemy = { ...e, hp: e.hp, def: e.def || 0 };
            gameData.combat.playerCd = 0;
            gameData.combat.enemyCd = 0;
            document.getElementById('combatDisplay').style.display = 'block';
            document.getElementById('enemyInfo').style.display = 'none';
            document.getElementById('combatBtn').textContent = 'ğŸƒ é€ƒè·‘';
            addLog(`âš”ï¸ é­é‡${e.name}!`, '#ff6b6b');
            updateCombatUI(); // ç«‹å³æ›´æ–°è¡€æ¡æ˜¾ç¤º
        }

        function nextEnemy() {
            gameData.currentEnemyIdx = (gameData.currentEnemyIdx + 1) % enemies.length;
            const e = enemies[gameData.currentEnemyIdx];
            document.getElementById('enemyName').textContent = e.name;
            document.getElementById('enemyPower').textContent = Math.floor(e.hp/5 + e.atk);
            document.getElementById('enemyAtk').textContent = e.atk;
            document.getElementById('enemyDrop').textContent = e.drops.herbs?'çµè‰ x1-3':e.drops.spiritStones?'çµçŸ³ x5-10':'ä¸¹è¯ x1-2';
        }

        function meditate() {
            gameData.player.cultivation += 25;
            addLog('ğŸ§˜ æ‰“åä¿®ç‚¼,ä¿®ä¸º+25', '#888');
        }

        function breakthrough() {
            const p = gameData.player;
            const req = getReqCultivation();
            if (p.cultivation < req) {
                addLog('âŒ ä¿®ä¸ºä¸è¶³,æ— æ³•çªç ´', '#ff4444');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç ´å¢ƒä¸¹buff
            const breakthroughBuff = gameData.buffs?.find(b => b.type === 'breakthrough');
            const buffBonus = breakthroughBuff ? breakthroughBuff.value : 0;
            
            const chance = 0.5 + buffBonus;
            if (Math.random() < chance) {
                p.cultivation -= req;
                p.stage++;
                if (p.stage > 10) {
                    p.stage = 1;
                    p.realm++;
                    addLog(`ğŸ‰ çªç ´æˆåŠŸ!è¿›å…¥${realms[p.realm]}`, '#ffd700');
                } else {
                    addLog(`âœ¨ çªç ´æˆåŠŸ!${realms[p.realm]}${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å'][p.stage-1]}é‡`, '#ffd700');
                }
                p.maxHp += 20;
                p.hp = p.maxHp;
                p.baseAtk += 2;
                p.baseDef += 1;
                
                // çªç ´æˆåŠŸåç§»é™¤ç ´å¢ƒä¸¹buff
                if (breakthroughBuff) {
                    gameData.buffs = gameData.buffs.filter(b => b.type !== 'breakthrough');
                    updateBuffDisplay();
                }
            } else {
                p.cultivation -= Math.floor(req * 0.3);
                addLog('ğŸ’” çªç ´å¤±è´¥,æŸå¤±30%ä¿®ä¸º', '#ff4444');
            }
        }

        function upgradeSkill(id) {
            const s = gameData.skills.find(x => x.id === id);
            const cost = s.cost * (s.level || 1);
            if (gameData.player.skillPoints >= cost) {
                gameData.player.skillPoints -= cost;
                s.level++;
                addLog(`âœ¨ ${s.name}æå‡åˆ°Lv.${s.level}`, '#ffd700');
                renderSkills();
                saveGame(); // ç«‹å³å­˜æ¡£
            }
        }

        function craftPill(id) {
            const r = recipes.find(x => x.id === id);
            const canCraft = Object.entries(r.cost).every(([k,v]) => gameData.player[k] >= v);
            if (!canCraft) {
                addLog('âŒ ææ–™ä¸è¶³', '#ff4444');
                return;
            }
            Object.entries(r.cost).forEach(([k,v]) => gameData.player[k] -= v);
            addLog(`âš—ï¸ ç‚¼åˆ¶æˆåŠŸ:${r.name}`, '#00ff88');
            
            // æ·»åŠ buffæ•ˆæœ
            if (id === 'spirit') {
                addBuff('èšæ°”ä¸¹', 'ä¿®ç‚¼é€Ÿåº¦+50%', 300, 'speed', 0.5); // 5åˆ†é’Ÿ = 300ç§’
            } else if (id === 'breakthrough') {
                addBuff('ç ´å¢ƒä¸¹', 'çªç ´æˆåŠŸç‡+30%', -1, 'breakthrough', 0.3); // æ°¸ä¹…ç›´åˆ°ä½¿ç”¨
            } else if (id === 'lifespan') {
                gameData.player.lifespan += 10;
                addBuff('å¯¿å…ƒä¸¹', 'å¯¿å…ƒ+10å¹´', -1, 'lifespan', 10);
            }
            
            updateBuffDisplay();
            saveGame(); // ç«‹å³å­˜æ¡£
        }

        // Buffç³»ç»Ÿ
        function addBuff(name, desc, duration, type, value) {
            if (!gameData.buffs) gameData.buffs = [];
            
            // ç§»é™¤åŒç±»å‹buff
            gameData.buffs = gameData.buffs.filter(b => b.type !== type);
            
            gameData.buffs.push({
                name,
                desc,
                type,
                value,
                endTime: duration > 0 ? Date.now() + duration * 1000 : -1
            });
            
            addLog(`âœ¨ è·å¾—å¢ç›Š: ${desc}`, '#ffd700');
        }

        function updateBuffDisplay() {
            const buffList = document.getElementById('buffList');
            if (!buffList) return;
            
            if (!gameData.buffs || gameData.buffs.length === 0) {
                buffList.innerHTML = '';
                return;
            }
            
            // æ¸…ç†è¿‡æœŸbuff
            const now = Date.now();
            gameData.buffs = gameData.buffs.filter(b => b.endTime === -1 || b.endTime > now);
            
            buffList.innerHTML = gameData.buffs.map(b => {
                let timeText = '';
                if (b.endTime > 0) {
                    const remaining = Math.ceil((b.endTime - now) / 1000);
                    timeText = ` (${remaining}s)`;
                }
                return `<div class="buff-icon" title="${b.desc}${timeText}">${b.name}${timeText}</div>`;
            }).join('');
        }

        function enterDungeon(idx) {
            const d = dungeons[idx];
            const power = getPlayerPower();
            if (power < d.power) {
                addLog('âŒ æˆ˜åŠ›ä¸è¶³!', '#ff4444');
                return;
            }
            // æ¨¡æ‹Ÿæˆ˜æ–—
            const dmg = Math.floor(d.power * 0.5);
            gameData.player.hp -= dmg;
            Object.entries(d.reward).forEach(([k,v]) => gameData.player[k] += v);
            addLog(`ğŸ° é€šå…³${d.name}!è·å¾—å¥–åŠ±`, '#ffd700');
            if (Math.random() < 0.5) dropEquipment();
            if (Math.random() < 0.7 && gameData.pillsBag.length < 50) dropPill(); // å‰¯æœ¬æœ‰æ›´é«˜æ¦‚ç‡æ‰è½ä¸¹è¯
        }

        function setLocation(idx) {
            gameData.currentLocation = idx;
            initTravel();
            document.getElementById('currentLocation').textContent = locations[idx];
        }

        function startTravel() {
            if (gameData.player.spiritStones < 10) {
                addLog('âŒ çµçŸ³ä¸è¶³', '#ff4444');
                return;
            }
            gameData.player.spiritStones -= 10;
            
            const events = [
                () => { const n=rand(1,5); gameData.player.herbs+=n; return `ğŸŒ¿ é‡‡é›†åˆ°${n}æ ªçµè‰`; },
                () => { const n=rand(10,30); gameData.player.spiritStones+=n; return `ğŸ’ å‘ç°${n}é¢—çµçŸ³`; },
                () => { dropEquipment(); return 'ğŸ å‘ç°å®ç‰©!'; },
                () => { gameData.player.skillPoints+=1; return 'ğŸ“œ é¢†æ‚ŸåŠŸæ³•å¿ƒå¾—'; },
                () => 'ğŸ‘£ ä¸€æ— æ‰€è·...'
            ];
            const result = events[rand(0, events.length-1)]();
            addLog(`ğŸ² ${result}`, '#ffd700');
            document.getElementById('travelLog').innerHTML += `<div class="log-entry">${result}</div>`;
        }

        function clickItem(id) {
            id = Number(id);
            const item = gameData.bag.find(x => x.id === id);
            if (isEquipped(item)) {
                gameData.equipment[item.type] = null;
                addLog(`è„±ä¸‹${item.name}`, '#888');
            } else {
                gameData.equipment[item.type] = item;
                addLog(`è£…å¤‡${item.name}`, '#00ff88');
            }
            renderBag();
            renderEquipped();
        }

        // å·¥å…·å‡½æ•°
        function getReqCultivation() {
            const base = 50;
            const stageMultiplier = Math.pow(1.5, gameData.player.stage - 1);
            const realmMultiplier = Math.pow(100, gameData.player.realm);
            return Math.floor(base * stageMultiplier * realmMultiplier);
        }
        function getSkillBonus(type) { return gameData.skills.filter(s => s.effect === type).reduce((a,s) => a + s.value * s.level, 0); }
        function getBuffBonus(type) {
            if (!gameData.buffs) return 0;
            const now = Date.now();
            return gameData.buffs
                .filter(b => b.type === type && (b.endTime === -1 || b.endTime > now))
                .reduce((a, b) => a + b.value, 0);
        }
        function getEquipBonus(type) { const eq = gameData.equipment; return (eq.weapon?.atk || 0) + (eq.armor?.def || 0) + (eq.accessory?.hp || 0); }
        function getPlayerPower() { return Math.floor(gameData.player.maxHp/5 + getTotalAtk() + getTotalDef()); }
        function getTotalAtk() { return gameData.player.baseAtk + getSkillBonus('atk') + getEquipBonus('atk'); }
        function getTotalDef() { return gameData.player.baseDef + getSkillBonus('def') + getEquipBonus('def'); }
        function isEquipped(item) { return Number(gameData.equipment[item.type]?.id) === Number(item.id); }
        function getRarityName(r) { return {common:'æ™®é€š',rare:'ç¨€æœ‰',epic:'å²è¯—',legendary:'ä¼ è¯´'}[r]; }
        function getRarityColor(r) { return {common:'color:#aaa',rare:'color:#4169e1',epic:'color:#9932cc',legendary:'color:#ffd700'}[r]; }
        function rand(min,max) { return Math.floor(Math.random() * (max-min+1)) + min; }
        function sellAllItems() {
            const unequipped = gameData.bag.filter(item => !isEquipped(item));
            if (unequipped.length === 0) {
                addLog('æ²¡æœ‰å¯å‡ºå”®çš„è£…å¤‡ï¼ˆå·²ç©¿æˆ´çš„ä¸ä¼šè¢«å‡ºå”®ï¼‰', '#888');
                return;
            }
            let totalValue = 0;
            const rarityValues = { common: 5, rare: 15, epic: 40, legendary: 100 };
            unequipped.forEach(item => {
                totalValue += rarityValues[item.rarity] || 5;
            });
            gameData.player.spiritStones += totalValue;
            gameData.bag = gameData.bag.filter(item => isEquipped(item));
            renderBag();
            saveGame();
            addLog(`ğŸ’° å‡ºå”®${unequipped.length}ä»¶è£…å¤‡ï¼Œè·å¾—${totalValue}çµçŸ³`, '#ffd700');
        }

        function sellItem(id, event) {
            event.stopPropagation();
            id = Number(id);
            const item = gameData.bag.find(x => x.id === id);
            if (!item || isEquipped(item)) return;
            
            const rarityValues = { common: 5, rare: 15, epic: 40, legendary: 100 };
            const value = rarityValues[item.rarity] || 5;
            gameData.player.spiritStones += value;
            gameData.bag = gameData.bag.filter(x => x.id !== id);
            renderBag();
            saveGame();
            addLog(`ğŸ’° å‡ºå”®${item.name}ï¼Œè·å¾—${value}çµçŸ³`, '#ffd700');
        }

        function switchBagTab(tab) {
            document.getElementById('bagTab-equipment').classList.toggle('active', tab === 'equipment');
            document.getElementById('bagTab-pills').classList.toggle('active', tab === 'pills');
            document.getElementById('bagContent-equipment').style.display = tab === 'equipment' ? 'block' : 'none';
            document.getElementById('bagContent-pills').style.display = tab === 'pills' ? 'block' : 'none';
        }

        function forgeItem(type) {
            const costs = { weapon: { stones: 20, herbs: 10 }, armor: { stones: 20, herbs: 10 }, accessory: { stones: 30, herbs: 15 } };
            const cost = costs[type];
            
            if (gameData.player.spiritStones < cost.stones || gameData.player.herbs < cost.herbs) {
                addLog('âŒ ææ–™ä¸è¶³ï¼Œæ— æ³•é”»é€ ', '#ff4444');
                return;
            }
            
            if (gameData.bag.length >= 50) {
                addLog('âŒ èƒŒåŒ…å·²æ»¡ï¼Œæ— æ³•é”»é€ ', '#ff4444');
                return;
            }
            
            gameData.player.spiritStones -= cost.stones;
            gameData.player.herbs -= cost.herbs;
            
            // é”»é€ å“è´¨æ¦‚ç‡
            const randVal = Math.random();
            let rarity;
            if (randVal < 0.5) rarity = 'common';
            else if (randVal < 0.8) rarity = 'rare';
            else if (randVal < 0.95) rarity = 'epic';
            else rarity = 'legendary';
            
            const item = {
                id: Date.now(),
                name: generateItemName(type, rarity),
                type, rarity,
                atk: type==='weapon'?rand(5,15)*(rarity==='legendary'?3:rarity==='epic'?2:rarity==='rare'?1.5:1):0,
                def: type==='armor'?rand(3,10)*(rarity==='legendary'?3:rarity==='epic'?2:rarity==='rare'?1.5:1):0,
                hp: type==='accessory'?rand(20,50)*(rarity==='legendary'?3:rarity==='epic'?2:rarity==='rare'?1.5:1):0
            };
            
            gameData.bag.push(item);
            renderBag();
            saveGame();
            
            const resultDiv = document.getElementById('forgeResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 10px;">${type==='weapon'?'ğŸ—¡ï¸':type==='armor'?'ğŸ›¡ï¸':'ğŸ’'}</div>
                <div style="font-size: 1.3em; font-weight: bold; ${getRarityColor(rarity)}">é”»é€ æˆåŠŸï¼</div>
                <div style="font-size: 1.1em; margin: 10px 0;">${item.name}</div>
                <div style="color: #888;">${item.atk?`æ”»å‡»+${item.atk}`:item.def?`é˜²å¾¡+${item.def}`:`ç”Ÿå‘½+${item.hp}`}</div>
            `;
            
            addLog(`âš’ï¸ é”»é€ æˆåŠŸï¼è·å¾—${getRarityName(rarity)}${item.name}`, getRarityColor(rarity));
        }
        function addLog(msg, color='#fff') {
            const log = document.getElementById('logContainer');
            log.innerHTML = `<div class="log-entry" style="color:${color}">${new Date().toLocaleTimeString()} ${msg}</div>` + log.innerHTML;
            if (log.children.length > 50) log.lastChild.remove();
        }
        function clearLog() { document.getElementById('logContainer').innerHTML = ''; }

        // å­˜æ¡£ç³»ç»Ÿ
        function saveGame() {
            gameData.lastOnline = Date.now();
            const saveData = JSON.stringify(gameData);
            localStorage.setItem('xiuxianIdle', saveData);
            console.log('æ¸¸æˆå·²å­˜æ¡£ï¼ŒæŠ€èƒ½æ•°æ®:', gameData.skills.map(s => `${s.name}:Lv${s.level}`).join(', '));
        }

        function loadGame() {
            const saved = localStorage.getItem('xiuxianIdle');
            if (saved) {
                const parsed = JSON.parse(saved);
                console.log('è¯»å–å­˜æ¡£ï¼ŒåŸå§‹æŠ€èƒ½æ•°æ®:', parsed.skills ? parsed.skills.map(s => `${s.name}:Lv${s.level}`).join(', ') : 'æ— ');
                // æ·±åº¦åˆå¹¶å­˜æ¡£æ•°æ®
                mergeDeep(gameData, parsed);
            }
        }

        // æ·±åº¦åˆå¹¶å¯¹è±¡
        function mergeDeep(target, source) {
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    if (!target[key]) target[key] = {};
                    mergeDeep(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
        }

        function calculateOfflineReward() {
            const offline = (Date.now() - gameData.lastOnline) / 1000;
            const maxOffline = 12 * 3600;
            const actual = Math.min(offline, maxOffline);
            const reward = Math.floor(actual * (1 + gameData.player.realm * 0.5));
            gameData.player.cultivation += reward;
            if (reward > 0) document.getElementById('offlineReward').textContent = `ç¦»çº¿æ”¶ç›Š: +${reward}ä¿®ä¸º`;
        }

        function exportSave() {
            try {
                const json = JSON.stringify(gameData);
                const data = btoa(encodeURIComponent(json).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
                const modalHtml = `<textarea id="saveCode" style="width:100%;height:100px;background:rgba(0,0,0,0.3);color:#fff;border:1px solid #e94560;padding:10px;border-radius:5px;resize:none;" readonly>${data}</textarea><p style="color:#888;margin-top:10px;font-size:0.85em;">å¤åˆ¶ä¸Šæ–¹ä»£ç ä¿å­˜ï¼Œå¯¼å…¥æ—¶ç²˜è´´ä½¿ç”¨</p><button class="btn btn-primary" style="margin-top:10px;" onclick="copySaveCode()">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>`;
                showModal('å¯¼å‡ºå­˜æ¡£', modalHtml);
            } catch(e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }

        function importSave() {
            const input = prompt('è¯·è¾“å…¥å­˜æ¡£ä»£ç :');
            if (input) {
                try {
                    const json = decodeURIComponent(atob(input).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                    Object.assign(gameData, JSON.parse(json));
                    saveGame();
                    location.reload();
                } catch(e) { alert('å­˜æ¡£ä»£ç æ— æ•ˆ: ' + e.message); }
            }
        }

        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—?æ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±!')) {
                localStorage.removeItem('xiuxianIdle');
                location.reload();
            }
        }

        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function copySaveCode() {
            const textarea = document.getElementById('saveCode');
            if (textarea) {
                textarea.select();
                document.execCommand('copy');
                alert('å­˜æ¡£ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
        }

        // å¯åŠ¨
        window.onload = init;
    </script>
</body>
</html>
